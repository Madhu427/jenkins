pipeline {
  agent {
    label 'WORKSTATION'
  }

   options {
          ansiColor('xterm')
   }

    parameters {
       choice(name: 'ENV', choices: ['', 'dev', 'prod'], description: 'Pick Environment')
     }

  stages {
            stage('VPC') {
              steps {
               dir('vpc') {
               git branch: 'master', url: 'https://github.com/Madhu427/terraform-vpc.git'
               sh'''
               terraform init -backend-config=env/${ENV}-backend.tfvars
               terraform apply -auto-approve -var-file=env/${ENV}.tfvars
               '''
                }
              }

            }


             stage('ALB-n-DB') {
               parallel {

               stage('DB') {
                  steps {
                     dir('db') {
                     git branch: 'master', url: 'https://github.com/Madhu427/terraform-db.git'
                     sh'''
                     terraform init -backend-config=env/${ENV}-backend.tfvars
                     terraform apply -auto-approve -var-file=env/${ENV}.tfvars
                     '''
                    }
                  }

               }

               stage('ALB') {
                  steps {
                    dir('alb') {
                    git branch: 'master', url: 'https://github.com/Madhu427/terraform-mutable-alb.git'
                    sh'''
                    terraform init -backend-config=env/${ENV}-backend.tfvars
                    terraform apply -auto-approve -var-file=env/${ENV}.tfvars
                    '''
                    }

                  }

               }


              }
             }


             stage('BACKEND') {
               parallel {
                   stage ('CART')
                       steps {
                           dir('cart')
                           git branch: 'main', url: 'https://github.com/Madhu427/cart.git'
                           sh'''
                           export TF_VAR_APP_VERSION=1.0.1
                           cd terraform-mutable
                           terraform init -backend-config=env/${ENV}-backend.tfvars
                           terraform apply -auto-approve -var-filr=env/${ENV}.tfvars
                           '''

                           }

                       }
                   }

                   stage('CATALOGUE') {
                      steps {
                         dir('catalogue')
                         sh'''
                         export TF_VAR_APP_VERSION=1.0.0
                         cd terraform-mutable
                         git branch: 'main', url: 'https://github.com/Madhu427/catalogue.git'
                         terraform init -backend-config=env/${ENV}-backend.tfvars
                         terraform apply -auto-approve -var-file=env${ENV}.tfvars
                         '''
                      }
                   }

                   stage('DISPATCH') {
                     steps {
                       dir('dispatch')
                       sh'''
                       export TF_VAR_APP_VERSION=1.0.0
                       cd terraform-mutable
                       terraform init -backend.config=env/${ENV}-backend.tfvars
                       terraform apply -auto-approve -var-file=env/${ENV}.tfvars
                       '''
                     }
                   }

                   stage('SHIPPING') {
                     steps {
                       dir('shipping')
                       sh'''
                       export TF_VAR_APP_VERSION=1.0.0
                       cd terraform-mutable
                       terraform init -backend-config=env/${ENV}-backend.tfvars
                       terraform apply -auto-approve -var-file=env/${ENV}.tfvars
                       '''
                     }
                   }

                   stage('PAYMENT') {
                     steps {
                       dir('payment')
                       sh'''
                       export TF_VAR_APP_VERSION=1.0.1
                       cd terraform-mutable
                       terraform init -backend.config=env/${ENV}-backend.tfvars
                       terraform apply -auto-approve -var-file=env/${ENV}.tfvars
                       '''
                     }

                   }

                     stage('USER') {
                       steps {
                         dir('user')
                         sh'''
                         export TF_VAR_APP_VERSION=1.0.1
                         cd terraform-mutable
                         terraform init -backend.config=env/${ENV}-backend.tfvars
                         terraform apply -auto-approve -var-file=env/${ENV}.tfvars
                         '''
                       }
                     }


                    stage('FRONTEND1'){
                       steps {
                          dir('frontend1')
                          sh'''
                          export TF_VAR_APP_VERSION=1.0.1
                          cd terraform-mutable
                          terraform init -backend.config=env/${ENV}-backend.tfvars
                          terraform apply -auto-approve -var-file=env/${ENV}.tfvars
                          '''
                       }

                    }
               }


  post {
    always {
     cleanWs()
    }
  }
}


